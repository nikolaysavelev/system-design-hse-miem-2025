# Архитектура хранения данных: "Кто твой предок?"
[ДЗ_1 с ФТ и НФТ](https://github.com/nikolaysavelev/system-design-hse-miem-2025/pull/6/files?short_path=c2b1b13#diff-c2b1b137c8b6980993e87a6c87d68e80f5d9287d3828b50d33049d9581a3d7fc)

[ДЗ_2 с сервисами](https://github.com/nikolaysavelev/system-design-hse-miem-2025/pull/15/files?short_path=296604c#diff-296604cd18c064534012a6528e0a93b49ffa6ec41ac137e35ed853adc05e6942)

## 1. Выбор баз данных по сценариям

| Сервис / Сценарий                              | Тип хранилища        | Технология                          | Обоснование выбора                                      |
|------------------------------------------------|----------------------|-------------------------------------|---------------------------------------------------------|
| User Profile Service                           | Реляционная БД       | PostgreSQL                          | Четкая схема, транзакции, согласованность               |
| Genealogy Service (родословные, граф)          | Графовая БД / SQL    | PostgreSQL + pgRouting / Neo4j      | Хранение и обход связей (предки ↔ потомки)              |
| Document Management Service                    | Объектное хранилище  | S3 / MinIO / Yandex Object Storage  | Массовое хранение сканов документов                     |
| Verification Service                           | Реляционная БД       | PostgreSQL                          | CRUD по задачам верификации, управление статусами       |
| Search & Discovery Service                     | Поисковый движок     | Elasticsearch                       | Полнотекстовый поиск, скоринг                           |
| Audit & History Service                        | Журнал событий       | PostgreSQL / ClickHouse             | Высокая скорость записи, историчность                   |
| Notification Service                           | Очереди / event-log  | RabbitMQ / Redis Streams            | Асинхронные события и обработка сообщений               |
| Auth Service                                   | Реляционная БД       | PostgreSQL                          | Пользователи, OAuth, сессии                             |
| Admin Panel                                    | Использует API       | -                                   | Интеграция с другими сервисами через API                |

### Дополнительно используемые технологии

- Redis — кэширование профилей, токенов, rate-limiting
- S3 / MinIO — хранение больших вложений
- Elasticsearch — быстрый поиск по документам, профилям и родословным

---

## 2. Репликация и шардирование

### PostgreSQL

#### Репликация

- Используется master-slave (primary-read replica) схема
- Streaming replication
- Для отказоустойчивости — Patroni / Stolon / Barman
- Чтение направляется на реплики (например, отчеты, публичный просмотр)

#### Шардирование

- Горизонтальное шардирование по хэшу ID пользователя
- Возможна реализация на базе Citus или ручное шардирование на уровне сервиса
- Разделение по бизнес-доменам:
  - Пользователи
  - Родословные
  - Документы и верификация

### Elasticsearch

#### Репликация

- Встроенная в Elasticsearch (репликация шардов)
- Минимум 1 реплика на шард

#### Шардирование

- Индекс → несколько шардов
- Шардирование по:
  - Типу записи
  - Региону
  - Диапазону дат

### S3 / Object Storage

#### Репликация

- Обеспечивается на уровне провайдера (Yandex Cloud, AWS, VK Cloud)
- В случае on-premises — MinIO с репликацией между узлами

#### Шардирование

- Автоматическое распределение в хранилище
- Не требует ручного вмешательства

### RabbitMQ

#### Репликация

- Используется кластер HA с queue mirroring
- Обеспечивает устойчивость к сбоям узлов

#### Шардирование

- Распределение очередей по типу задач (уведомления, подтверждение, логирование)
- Использование отдельных exchange и routing key для масштабирования

---

## 3. Примеры сценариев использования хранилищ

### Поиск предков

- Elasticsearch — используется для быстрого поиска по полям (имя, дата, место)
- PostgreSQL — для детальной информации о пользователе и родословной
- Redis — кеширование популярных запросов

### Загрузка документа

- Фронтенд → Document Service → S3
- Метаданные о документе сохраняются в PostgreSQL
- Создание задания на верификацию (RabbitMQ → Verification Service)

### Отображение дерева предков

- Genealogy Service делает запрос к PostgreSQL или Neo4j
- Используются CTE-запросы или обход графа
- Часто используемые ветви кэшируются в Redis