## Дано

Your Architectural Kata is...

Mock Internet UN

Organization running "Mock UN" events wants to take its events online, permitting students to participate online

Requirements: student-diplomats must be able to video-chat with one another; student-diplomats must be able to "give speeches" to the 
"assembly" (video-chat to the entire group); (mocked) world events (created by moderators) distributed via (mock) "news sites"; 
moderators must be able to monitor any video chat for appropriateness

Users: 500 or so "diplomats" per "mock UN" gathering; dozens of moderators per "mock UN"; many "mock UN"s simultaneously; no new 
hardware requirements on students

## Решение

### 1. Отсев

1. Ключевые требования
* Видеочаты между студентами-дипломатами.
* Возможность выступлений перед всей аудиторией ("общий зал").
* Мониторинг видеочатов модераторами.
* Распределение имитированных мировых событий через "новостные сайты".
2. Исключены
* Требования к установке специального ПО на устройства студентов (проект должен быть полностью браузерным).
* Поддержка VR/AR (не указано в требованиях).
3. Оценка последствий невыполнения задач
* Если не реализовать мониторинг чатов модераторами, это нарушит требования безопасности и приведет к блокировке платформы Роскомнадзором.
4. Критерии успеха
* Метрики: 99.9% доступности сервиса, время загрузки главной страницы ≤ 2 секунды.
* Бизнес-метрики: 70% повторных участий в мероприятиях, 100 мероприятий в месяц.
5. Анализ ресурсов
* Ограничение на облачные расходы — 500 тыс. рублей в месяц (например).
* Использование Яндекс.Облака как основного провайдера (нельзя использовать западные провайдеры).

### 2. Scope Refinement

1. Видеочаты
* Поддержка 1:1 и групповых чатов (до 10 участников в группе).
* Использование WebRTC для низкой задержки без установки клиентов.
2. Выступления
* Режим "общего зала" с трансляцией видео и аудио всем участникам.
* Очередь выступающих, управляемая модераторами.
3. Мониторинг модераторов
* Возможность "подключения" к любому активному видеочату в режиме наблюдения.
* Функция отправки предупреждений участникам.
4. Новостные сайты
* Генерация событий модераторами (например, "землетрясение в регионе X").
* Интеграция с системой мероприятий для автоматического обновления новостей.
5. MVP
* Видеочаты (1:1 и групповые до 10 участников).
* Общий зал с очередью выступлений.
* Мониторинг чатов модераторами.
6. Хотелки
* Запись чатов для повторного просмотра.
* Интеграция с календарем мероприятий.
7. Корнер-кейсы
* Поддержка низкой скорости интернета (автоматическое снижение качества видео).
* Выступление с плохой аудиосвязью (режим текстовых сообщений).

### 3. Функциональные требования

0. Доменная модель
* Пользователь: роль (студент/модератор), профиль, история участия в мероприятиях.
* Мероприятие: тема, дата, список участников, связанные новости.
* Чат: тип (1:1 или групповой), участники, логи действий.
* Новость: текст, метаданные (автор, дата), связь с мероприятием.
1. Для студентов-дипломатов
* Регистрация/вход через почту или SSO (университетские аккаунты).
* Создание и присоединение к видеочатам.
* Выступление в общем зале с возможностью голосования за темы.
2. Для модераторов
* Создание мероприятий (название, дата, темы).
* Добавление/редактирование новостных событий.
* Мониторинг видеочатов и отправка предупреждений.
3. Для системы
* Масштабирование под 500 участников на мероприятие и одновременную работу сотен мероприятий.
* Логирование действий модераторов и пользователей.

### 4. Нефункциональные требования

1. Производительность
* Задержка видеочатов ≤ 200 мс (для WebRTC).
* Время загрузки главной страницы ≤ 2 секунды.
2. Безопасность
* Шифрование данных (HTTPS, SRTP для видеочатов).
* Соответствие российскому законодательству (ФЗ-152).
3. Масштабируемость
* Облачные решения (например, Яндекс.Облако) для динамического масштабирования серверов.
4. Совместимость
* Поддержка Chrome, Firefox, Safari (последние версии).
* Адаптивный интерфейс для мобильных устройств.
5. Мониторинг
* Использование Prometheus + Grafana для метрик (время отклика API, ошибки 5xx).
* Логирование через ELK Stack.
7. SLA
* Доступность 99.9% в месяц.
* Время восстановления после сбоя: ≤ 1 час.
8. UX
* Поддержка WCAG 2.1 для доступности.
* Минимизация кликов для основных действий (вход в чат за 2 шага).

### 5. Ограничения

1. Технические
* Нельзя требовать от студентов установки дополнительного ПО.
* Ограничения на использование WebRTC в корпоративных сетях (возможно, реализовать fallback на медиасерверы).
* Поддержка SSO через университетские системы (OAuth 2.0).
2. Юридические
* Хранение персональных данных пользователей в РФ. Обязательна регистрация оператора ПДн в Роскомнадзоре.
* Если платформа используется в госорганах или образовательных учреждениях, требуется сертификат соответствия требованиям цифровой экосистемы РФ.
* Запрет на использование зарубежных CDN (например, Cloudflare) без локализации данных в РФ.
* Запрет на хостинг в иностранных облаках (AWS, Google Cloud).
3. Бюджетные
* Оптимизация затрат на облачные ресурсы (например, использование spot-инстансов для нетребовательных задач).
4. Импортозамещение
* Обязательное использование российских ОС (ALT Linux , Ред ОС) на серверах.
* Для криптографии — алгоритмы ГОСТ 28147-89 , ГОСТ Р 34.10-2012 (вместо RSA/AES).
* Использование КриптоПро для сертификатов SSL/TLS.
5. Бизнес-метрики
* DAU: 500 пользователей на мероприятие.
* Retention: 70% повторных участий.

### 6. Расчет нагрузки:

#### 6.1 Трафик

1. Видеочаты
* Каждый участник отправляет поток 1–2 Мбит/с (видео 720p).
* Для 500 участников: 500 × 2 Мбит/с = 1 Гбит/с на мероприятие.
* Использование SFU (Selective Forwarding Unit) для снижения нагрузки на клиентов.
2. Общий зал
* Трансляция одного потока всем участникам → 500 × 1 Мбит/с = 500 Мбит/с.
* Использование CDN (например, Cloudflare) для стриминга.
3. RPS и ресурсы
* Пиковая нагрузка на API: 1000 запросов/секунду (например, при регистрации 500 пользователей).
* Каждый видеопоток требует ~0.5 CPU-ядра → 250 ядер для 500 участников.

#### 6.2 БД

1. Сценарии использования
* Чтение: запросы к новостям, спискам мероприятий.
* Запись: логирование действий, обновление состояния чатов.
2. Рекомендуемые технологии
* PostgreSQL для структурированных данных (пользователи, мероприятия).
* Redis для кэширования новостей и временных данных чатов.
3. Нагрузка
* Пиковая нагрузка: 1000 операций чтения/секунду (новости), 500 операций записи/секунду (логи).
4. Примерный расчет емкости
* Пользователи. 500 участников × 10 мероприятий в год = 5000 пользователей. 
Каждый пользователь: ~1 КБ данных (логин, пароль, роль, метаданные).
Итого: ~5 МБ.
* Мероприятия. 100 мероприятий в месяц × 12 месяцев = 1200 мероприятий в год.
Каждое мероприятие: ~10 КБ (тема, дата, список участников).
Итого: ~12 МБ.
* Логи действий. Среднее количество записей: 1000 событий/мероприятие × 1200 мероприятий = 1.2 млн записей.
Каждая запись: ~200 Байт (дата, пользователь, действие).
Итого: ~240 МБ.
* Новости. 50 событий/мероприятие × 1200 мероприятий = 60 тыс. записей.
Каждое событие: ~1 КБ (текст, метаданные).
Итого: ~60 МБ.
* Записи чатов (опционально): 1 ТБ на 100 часов видеозаписи.
* Итого для всей БД: ~320 МБ на год без записей чатов, и ~1 ТБ при наличии записей.