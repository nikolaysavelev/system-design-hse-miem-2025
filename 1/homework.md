# Задание

Your Architectural Kata is...
Concert Comparison
A concert ticketing site with big acts and high volume needs an elastic solution to sell tickets.

Users: thousand of concurrent users, bursts of up to 10,000/second when tickets go on sale

Requirements:

- Allow concurrent ticket buying
- Do not sell a seat more than once!
- Shoppers can see an overview of remaining seats

Additional Context:

- Consider an implementation in both Space Based and Microservices architecture style
- Identify the tradeoffs for each solution


# Сбор и анализ требований 
## 1. Отсев
Все три исходных пункта считаю релевантными, каждый из них напрямую влияет на архитектурные решения.
- Одновременная покупка билетов относится к устойчивости и возможности множественных параллельных операций покупки.
- Гарантия консистентности данных необходима, чтобы:
  - одна сущность (билет) не могла быть закреплена за несколькими пользователями одновременно;
  - пользователи получали достоверную информацию о доступных местах в момент времени.
## 2. Scope Refinement
Исходя из формулировки задания возникает потребность в интеграции с платёжной системой. Пользователь должен иметь возможность оплачивать билеты картой через редирект на платёжную платформу. Таким образом, границы ответственности системы заключены в отображении билетов, их покупке (то есть закреплением за конкретным пользователем), оплаты (через внешнюю систему). Всё остальное (в первую очередь обработка платежей) к системе прямого отношения не имеет.
## 3. Функциональные требования 
Оформлю в формате Use-Case
- 3.1 Я, как пользователь, хочу иметь возможность зарегистрироваться в системе. Система должна предоставить форму регистрации с полями:
  - Фамилия, имя, номер телефона, электронная почта, логин (псевдоним), пароль и форму для согласия с обработкой ПДн.
- 3.2 Я, как пользователь, хочу видеть все доступные события, на которые я могу купить билеты (кто выступает, когда и где). 
  -  Система должна предоставлять актуальную информацию о событиях, включая их описание, дату и место, на момент запроса данных со стороны пользователя.
-  3.3 Я, как пользователь, хочу иметь возможность купить билет на событие и, тем самым, закрепить за собой конкретное место на событии.
    -  Система должна предоставить возможность покупки билета (при условии, что он ранее не был куплен и на данный момент не закреплён ни за одним пользователем) с помощью онлайн формы ввода платёжных данных.
-  3.4 Я, как пользователь, хочу иметь возможность выполнить оплату онлайн с помощью карты или системы быстрых платежей.
    -  Система должна поддерживать оплату с помощью сторонних сервисов платёжных транзакций - переводить на платёжную форму, обрабатывать отклик от системы платежей об успешной транзакции и, после подтверждения, высылать пользователю купленный билет в установленном формате.
    -  В обратном случае, когда платёжная система не предоставила подтверждение об успешной операции, необходимо откатить процедуру закрепления билета за пользователем, чтобы билет остался доступным для приобретения. 
    -  В случае, если система не получила подтверждения от платёжной платформы в течение 5 минут, билет автоматически возвращается в пул доступных, а пользователь получает соответствующее уведомление.
-  3.5 Я, как пользователь, хочу получить формальное подтверждение факта покупки в виде билета / иного документа, а также уведомление о покупке.
    -  После покупки билета пользователю необходимо отправить PUSH-уведомление и/или письмо на электронную почту с подтверждением о выполнении операции.
-  3.6 Я, как пользователь, хочу иметь возможность просматривать историю покупки билетов, а также иметь к ним непосредственный доступ, прямо в системе.
    -  Необходимо реализовать личный кабинет пользователя, отображающий купленные билеты, их статус (Использован, Истёк, Отменён), а также персональную информацию пользователя, которую он указывал при регистрации. 
    -  Кроме того, необходимо предусмотреть возможность редактирования полей (Фамилия, имя, номер телефона, электронная почта, логин, пароль). Номер телефона, электронная почта и логин доступны к изменению только при условии, что новое значение не занято другим пользователем.
    -  Редактирование критичных данных (почта, телефон, логин) требует верификации через код подтверждения на новое значение
-  3.7 Я, как администратор системы, хочу иметь возможность загружать информацию о новых событиях
    - Необходимо реализовать внутренний контур системы, через который администратор сможет создавать новые события
-  3.8 Я, как администратор системы, хочу иметь возможность редактировать существующие события: изменять, удалять
    - В системе должна быть предусмотрена возможность редактирования существующих событий
        - В том числе название события, артист, описание, адрес, время
        - Кроме того, предусмотреть возможность добавления новых / удаления существующих билетов
        - При удалении существующего билета, который был забронирован за пользователем, отправлять уведомление и оформлять возврат. При неудачной попытке возврата повторить операцию и уведомить администратора
-  3.9 Я, как администратор системы, хочу иметь возможность создавать новых артистов
    - Реализовать добавление артистов в систему с уточнением имени, рода деятельности, жанра, краткой биографии, списка работ (дискография и пр.)
-  3.10 Я, как администратор системы, хочу иметь возможность редактировать существующих артистов
    - Удаление необязательных полей и изменение всех полей, описанных в прошлом пункте
## 4. Нефункциональные требования
- 4.1 Производительность
  - Время ответа: не более 1000 мс при 95-м перцентиле
  - Пиковая нагрузка: 10 000 RPS без деградации более чем 5% запросов
- 4.2 Масштабируемость
  - Поддержка горизонтального масштабирования без остановки
  - Эластичное масштабирование под всплески трафика
- 4.3 Доступность
  - Доступность: не ниже 99.9%
  - Продажа билетов должна начинаться не менее чем за 60 дней до события
- 4.4 Консистентность
  - Данные о билетах должны быть актуальными в момент запроса
  - Одна сущность (билет) не может быть продана более одного раза
- 4.5 Отказоустойчивость
  - При сбое платёжного шлюза система должна возвращать билет в пул
  - Логирование всех сбоев и возможность восстановления состояния
- 4.6 Безопасность
  - Соответствие ФЗ-152 (персональные данные)
  - Шифрование трафика (HTTPS, TLS 1.2+)
  - Использование сертифицированных платёжных шлюзов
  - Не хранить CVV, PIN, номера карт
- 4.7 Поддерживаемость
  - Возможность подключения новых платёжных систем и форматов билетов
  - Панель администратора для мониторинга ошибок и активности
- 4.8 Логи
  - Логирование всех операций покупки
  - Хранение логов не менее 1 года
  - Запись: время, IP, пользователь, статус
## 5. Ограничения
- 5.1 Юридические
  - Соответствие ФЗ-152 и законам РФ
  - Хранение данных на территории РФ
  - Использование только разрешённых в РФ платёжных провайдеров и технологий
- 5.2 Финансово-организационные
  - Бюджет ограничен, инфраструктурные и командные ресурсы ограничены
  - Срок реализации MVP: не более 3 месяцев
  - Не допускается использование платных зарубежных облаков или сервисов
## 6. Расчёт нагрузки
- 6.1 Трафик
  - Среднее количество пользователей в сутки 50 000
  - Активная сессия занимает примерно 10 минут
  - Пиковый трафик с 10:00 до 22:00 МСК
  - Возможны всплески до 20 000 пользователей одновременно
  - Пиковый RPS до 10 000
- 6.2 Нагрузка на базу данных
  - До 5 000 операций записи в секунду
  - До 5 000 операций чтения в секунду
  - Предусмотренные меры:
    - PostgreSQL с WAL и репликацией
    - Redis для кэширования событий и схем залов
    - Вынос логов в отдельную БД или шину
    - Использование очередей (RabbitMQ/Kafka) для покупки и оплаты
    - Масштабирование чтений через реплики
