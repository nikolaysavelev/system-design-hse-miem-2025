TASK:
Your Architectural Kata is...
Trash Talk
A medium-sized (~1million users) game studio wants to implement a chat room feature for their game.

Requirements: players should be able to create public chat rooms, join into them, and discuss content at length with their peers.

You can assume that each player account has some kind of universally-identifiable unique playerId associated with that individual.

Additionally, while the game is purely a mobile app, the studio wants the chat functionality to be accessible on any device, including Web, desktop, and (obviously) mobile. (Their current games are written in native mobile tools--Kotlin/Android and Swift/iOS.)

The game studio does have several new titles almost ready for release, and wants to be able to use the same chat system for each of these new games, as well.

## **Решение**

---

### **1. Отсев**  
**Цель:** Проверить необходимость и реализуемость чат-системы.  

- **Что будет, если не сделать чат?**  
  - Игроки могут уходить в сторонние мессенджеры (Discord, Telegram), что снижает вовлеченность в игру.  
  - Потеря возможности монетизации (например, продажа стикеров, премиум-чатов).  
 
- **Метрики:**
  - DAU чата
  - среднее время в чате
  - количество сообщений в день 

---

### **2. Scope Refinement**  
- **Пользователи:**  
  - Игроки
  - Модераторы
  - Администраторы системы

- Создание комнат, поиск и вход в существующие, отправка/получение текстовых сообщений, история сообщений, удаление сообщений/отключение пользователей, настройка автоматических фильтров.

---

### **3. Функциональные требования**  

#### **Игрок**
- Регистрация и вход через playerId
- Создание публичных чат-комнат
- Поиск и вход в чат-комнаты
- Отправка текстовых сообщений
- Чтение истории сообщений
- Получение уведомлений о новых сообщениях
- Блокировка других игроков
- Настройка параметров уведомлений

#### **Модератор**
- Удаление сообщений
- Блокировка игроков
- Настройка фильтров запрещенных слов
- Просмотр и обработка жалоб
- Установка ограничений для пользователей

#### **Администратор**
- Мониторинг нагрузки системы
- Управление серверами
- Включение/отключение чата для игр
- Обновление функционала чата
- Резервное копирование данных
- Восстановление системы при сбоях

---

### **4. Нефункциональные требования**  
1. **Производительность:**  
   - **RPS:** ~1000 msg/sec (1M пользователей, 10% активны в чате, 1 сообщение/10 сек).  
   - Задержка < 200 мс для доставки сообщения.  
2. **Масштабируемость:**  
   - Горизонтальное масштабирование.  
3. **Отказоустойчивость:**  
   - Репликация БД, retry-логика для сообщений.  
4. **Безопасность:**  
   - HTTPS, проверка `playerId`, антиспам.  
5. **Мониторинг:**  
   - Метрики: онлайн-пользователи, RPS, ошибки.  
6. **Хранение данных:**  
   - Горячее хранение: 30 дней сообщений.  
   - Холодное: архив чатов.  

---

### **5. Ограничения**  
1. **Бизнес-модель:** B2C (игроки).  
2. **Метрики:** DAU чата = 100K, MAU = 500K.  
3. **География:** Global (но пики по регионам).  
4. **Устройства:** Mobile (iOS/Android), Web, Desktop.  
5. **Этап:** MVP → Full-Scale (сначала 1 игра, потом все).  
6. **Развертывание:** Cloud.  
7. **Бюджет:** Ограничен, нужен cost-effective дизайн.  
8. **Интеграции:** Существующий Auth-сервис (`playerId`).  

---

### **6. Расчет нагрузки**  
#### **Трафик:**  
- **Сообщения:**  
  - 100K DAU → 10K активных в чате → 1 msg/10 сек → **1000 RPS**.  
  - Размер сообщения: ~0.5 KB → **500 KB/sec сетевой нагрузки**.  
- **Соединения:**  
  - WebSocket: 10K одновременных соединений.  

#### **База данных:**  
- **Сообщения/день:** 10K users × 8640 сек/день × 0.1 msg/сек = **8.64M сообщений/день**.  
- **Хранение:**  
  - 8.64M × 0.5 KB = **4.32 GB/день** → **130 GB/месяц**.  
  - Redis (кеш последних сообщений) + PostgreSQL (история).  

#### **Серверы:**  
- 2-4 инстанса для обработки 1000 RPS.  

---

### **Выводы**  

1. **Основные сложности:**  
   - Обеспечение низкой задержки при доставке сообщений  
   - Поддержка масштабируемости под нагрузку
   - Кроссплатформенность

2. **Архитектурные решения:**  
   - Распределённая система с горизонтальным масштабированием (микросервисы или разделение на шарды)  
   - WebSocket для реального времени + REST API для истории сообщений  
   - Кэширование (Redis) для снижения нагрузки на основную БД  
